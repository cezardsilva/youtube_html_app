<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" href="favicon.ico" type="image/ico">
    <link rel="shortcut icon" href="favicon.ico">
    <link rel="apple-touch-icon" href="favicon.ico">
    <title>YouTube Video Embed with Controls</title>
    <style>
      body {
        background-color: black;
        color: white;
        font-family: Arial, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 20px;
      }
      #player {
        width: 100%;
        max-width: 640px;
        height: 360px;
      }
      #controls {
        margin-top: 20px;
        width: 100%;
        max-width: 640px;
        text-align: center;
      }
      #urlInput {
        width: 80%;
        padding: 10px;
        margin-bottom: 10px;
        background-color: #333;
        color: white;
        border: 1px solid #555;
      }
      .button-container {
        display: flex;
        justify-content: space-around;
        flex-wrap: wrap;
      }
      button {
        background: none;
        border: none;
        cursor: pointer;
        margin: 5px;
      }
      svg {
        width: 40px;
        height: 40px;
        fill: white;
      }
      .seek-svg {
        width: 48px;
        height: 48px;
        fill: white;
      }
      #timeDisplay {
        margin-top: 10px;
        font-size: 16px;
      }
      #pauseStopTimeDisplay {
        margin-top: 10px;
        font-size: 16px;
      }
      #videoTitleDisplay {
        margin-top: 10px;
        font-size: 16px;
        font-weight: bold;
      }
      #channelNameDisplay {
        margin-top: 10px;
        font-size: 14px;
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.7);
      }
      .modal-content {
        background-color: #222;
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        width: 300px;
        text-align: center;
        border-radius: 8px;
        color: white;
      }
      .modal-content input {
        width: 80%;
        padding: 10px;
        margin-top: 10px;
        background-color: #333;
        color: white;
        border: 1px solid #555;
      }
      .modal-content button {
        margin-top: 10px;
        padding: 8px 16px;
        background-color: #555;
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 4px;
      }
      .modal-content button:hover {
        background-color: #777;
      }
      .close {
        color: #aaa;
        float: right;
        font-size: 24px;
        font-weight: bold;
        cursor: pointer;
      }
    </style>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  </head>
  <body>
    <iframe
      id="player"
      src="https://www.youtube-nocookie.com/embed/SNCgkH8XJZU?enablejsapi=1"
      frameborder="0"
      allowfullscreen
      referrerpolicy="no-referrer-when-downgrade"
    ></iframe>

    <div id="controls">
      <input
        type="text"
        id="urlInput"
        placeholder="Paste YouTube URL here (watch, shorts, or live)"
      />
      <div class="button-container">
        <button onclick="loadVideo()" title="Load Video">
          <svg viewBox="0 0 24 24">
            <path
              d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"
            />
          </svg>
        </button>
        <button onclick="player.playVideo()" title="Play">
          <svg viewBox="0 0 24 24">
            <path d="M8 5v14l11-7z" />
          </svg>
        </button>
        <button onclick="pauseVideo()" title="Pause">
          <svg viewBox="0 0 24 24">
            <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" />
          </svg>
        </button>
        <button onclick="stopVideo()" title="Stop">
          <svg viewBox="0 0 24 24">
            <path d="M0 0h24v24H0z" fill="none" />
            <path
              d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z"
              fill="none"
            />
            <rect x="4" y="4" width="16" height="16" />
          </svg>
        </button>
        <button onclick="seekForward()" title="+30s">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="seek-svg"
            viewBox="0 0 40 40"
          >
            <g id="icon-skip--forward">
              <g id="forward_10-24px" transform="translate(8.198 8)">
                <g id="Icons" transform="translate(4.287 1)" fill="#fff">
                  <path
                    id="Path_425"
                    d="M18 13a6 6 0 11-6-6v4l5-5-5-5v4a8 8 0 108 8z"
                    transform="translate(-5 -1)"
                  />
                  <path
                    id="Path_524"
                    d="M1.2 5V2.478l-.8.21V2L2 1.45h.076V5zm4.423-1.431a1.884 1.884 0 01-.157.809 1.122 1.122 0 01-.441.5 1.255 1.255 0 01-.654.168 1.271 1.271 0 01-.66-.168 1.12 1.12 0 01-.442-.5 1.882 1.882 0 01-.157-.811v-.684a1.9 1.9 0 01.157-.813 1.131 1.131 0 01.439-.5 1.251 1.251 0 01.658-.17 1.248 1.248 0 01.656.171 1.14 1.14 0 01.443.505 1.879 1.879 0 01.159.811zm-.876-.8a1 1 0 00-.1-.513.335.335 0 00-.566 0 1.019 1.019 0 00-.1.514v.9a1 1 0 00.1.516.322.322 0 00.288.15.312.312 0 00.28-.151 1.01 1.01 0 00.1-.515z"
                    transform="translate(3.514 10)"
                  />
                </g>
              </g>
            </g>
          </svg>
        </button>
        <button onclick="seekBackward()" title="-30s">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="seek-svg"
            viewBox="0 0 40 40"
          >
            <g id="icon-skip--back">
              <g id="replay_10-24px" transform="translate(8.486 8)" fill="#fff">
                <path
                  id="Path_522"
                  d="M12 5V1L7 6l5 5V7a6 6 0 11-6 6H4a8 8 0 108-8z"
                />
                <path
                  id="Path_525"
                  d="M1.2 5V2.478l-.8.21V2L2 1.45h.076V5zm4.423-1.431a1.884 1.884 0 01-.157.809 1.122 1.122 0 01-.441.5 1.255 1.255 0 01-.654.168 1.271 1.271 0 01-.66-.168 1.12 1.12 0 01-.442-.5 1.882 1.882 0 01-.157-.811v-.684a1.9 1.9 0 01.157-.813 1.131 1.131 0 01.439-.5 1.251 1.255 0 01.658-.17 1.248 1.248 0 01.656.171 1.14 1.14 0 01.443.505 1.879 1.879 0 01.159.811zm-.876-.8a1 1 0 00-.1-.513.335.335 0 00-.566 0 1.019 1.019 0 00-.1.514v.9a1 1 0 00.1.516.322.322 0 00.288.15.312.312 0 00.28-.151 1.01 1.01 0 00.1-.515z"
                  transform="translate(8.514 11)"
                />
              </g>
            </g>
          </svg>
        </button>
        <button onclick="pasteUrl()" title="Paste">
          <svg viewBox="0 0 24 24">
            <path
              d="M19 2h-4.18C14.4.84 13.3 0 12 0c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v16c0 1.1 .9 2 2 2h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 18H5V4h2v3h10V4h2v16z"
            />
          </svg>
        </button>
        <button onclick="shareVideo()" title="Share">
          <svg viewBox="0 0 24 24">
            <path
              d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.61 1.31 2.92 2.92 2.92 1.61 0 2.92-1.31 2.92-2.92s-1.31-2.92-2.92-2.92z"
            />
          </svg>
        </button>
        <button onclick="promptSeekTo()" title="Seek to">
          <svg viewBox="0 0 24 24">
            <path
              d="M12 4V1L8 5l4 4V6c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z"
            />
          </svg>
        </button>
        <button onclick="saveVideoData()" title="Save">
          <svg viewBox="0 0 24 24">
            <path d="M17 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V7l-4-4zm-5 16c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm3-10H5V5h10v4z" />
          </svg>
        </button>
        <button onclick="window.location.href='list.html'" title="List Saved Videos">
          <svg viewBox="0 0 24 24">
            <path d="M3 4h18v2H3V4zm0 5h18v2H3V9zm0 5h18v2H3v-2z" />
          </svg>
        </button>
      </div>
      <div id="timeDisplay">Elapsed: 0:00 / Total: 0:00</div>
      <div id="pauseStopTimeDisplay"></div>
      <div id="videoTitleDisplay">Título do vídeo: Carregando...</div>
      <div id="channelNameDisplay">Canal: Carregando...</div>
    </div>
    <div id="seekModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeSeekModal()">&times;</span>
        <h3>Ir para tempo específico</h3>
        <input
          type="text"
          id="seekInput"
          placeholder="Digite hh:mm:ss ou mm:ss"
        />
        <button onclick="confirmSeek()">Ir</button>
      </div>
    </div>
    <div id="saveSuccessModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeSaveSuccessModal()">&times;</span>
        <h3>Vídeo salvo!</h3>
        <p>O vídeo foi salvo com sucesso no banco de dados.</p>
        <button onclick="closeSaveSuccessModal()">Fechar</button>
      </div>
    </div>

    <script>
      var player;
      let totalDuration = 0;
      let lastPauseStopTime = 0;
      let videoTitle = '';
      let channelName = '';
      let videoId = '';

      // Inicialização do Supabase com cabeçalho apikey explícito
      const supabaseUrl = 'https://ztbossnfxijdsclozmho.supabase.co';
      const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0Ym9zc25meGlqZHNjbG96bWhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg2NTU2NTAsImV4cCI6MjA3NDIzMTY1MH0.msvIzvLBmD0_wUHdHTPiQPoTtrhIkypY72GKVJyvwj4'; // Sua chave anônima
      const supabase = Supabase.createClient(supabaseUrl, supabaseKey, {
        global: {
          headers: {
            'apikey': supabaseKey
          }
        }
      });

      // Teste inicial de conexão com Supabase
      async function testSupabaseConnection() {
        console.log('Testando conexão com Supabase em index.html...', new Date().toLocaleString());
        console.log('Cabeçalhos enviados:', {
          Authorization: `Bearer ${supabaseKey.substring(0, 20)}...`,
          apikey: supabaseKey.substring(0, 20) + '...'
        });
        try {
          const { data, error } = await supabase.from('video_data').select('*').limit(1);
          if (error) {
            console.error('Erro na conexão com Supabase:', error);
            alert(`Erro na conexão com Supabase: ${error.message} (Código: ${error.code || 'N/A'})`);
            return false;
          } else {
            console.log('Conexão com Supabase bem-sucedida:', data);
            return true;
          }
        } catch (err) {
          console.error('Erro inesperado na conexão com Supabase:', err);
          console.log('Detalhes do erro:', {
            name: err.name,
            message: err.message || 'Mensagem vazia',
            stack: err.stack || 'Stack vazio'
          });
          alert(`Erro inesperado na conexão com Supabase: ${err.message || 'Erro sem mensagem (ver console)'}`);
          return false;
        }
      }
      testSupabaseConnection();

      function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${minutes}:${secs.toString().padStart(2, "0")}`;
      }

      function updateTimeDisplay() {
        if (player && player.getCurrentTime) {
          const currentTime = player.getCurrentTime();
          document.getElementById(
            "timeDisplay"
          ).textContent = `Elapsed: ${formatTime(
            currentTime
          )} / Total: ${formatTime(totalDuration)}`;
        }
      }

      function updatePauseStopTimeDisplay() {
        document.getElementById(
          "pauseStopTimeDisplay"
        ).textContent = `Vídeo pausado/parado em: ${formatTime(lastPauseStopTime)}`;
      }

      async function fetchVideoInfo(videoId) {
        const apiKey = "AIzaSyC0x-jQn9DpXi02rYNiBP1Vu8pP1W-5bpQ"; // Sua chave do YouTube
        const url = `https://www.googleapis.com/youtube/v3/videos?part=snippet&id=${videoId}&key=${apiKey}`;
        try {
          const response = await fetch(url);
          const data = await response.json();
          if (data.items && data.items.length > 0) {
            videoTitle = data.items[0].snippet.title;
            channelName = data.items[0].snippet.channelTitle;
            document.getElementById("videoTitleDisplay").textContent = `Título do vídeo: ${videoTitle}`;
            document.getElementById("channelNameDisplay").textContent = `Canal: ${channelName}`;
          } else {
            videoTitle = '';
            channelName = '';
            document.getElementById("videoTitleDisplay").textContent = "Título do vídeo: Não encontrado";
            document.getElementById("channelNameDisplay").textContent = "Canal: Não encontrado";
          }
        } catch (err) {
          console.error("Erro ao buscar informações do vídeo: ", err);
          videoTitle = '';
          channelName = '';
          document.getElementById("videoTitleDisplay").textContent = "Título do vídeo: Erro ao carregar";
          document.getElementById("channelNameDisplay").textContent = "Canal: Erro ao carregar";
        }
      }

      function onYouTubeIframeAPIReady() {
        player = new YT.Player("player", {
          events: {
            onReady: onPlayerReady,
            onStateChange: onPlayerStateChange,
          },
        });
      }

      function onPlayerReady(event) {
        totalDuration = player.getDuration();
        updateTimeDisplay();
        const currentSrc = document.getElementById("player").src;
        videoId = currentSrc.split("/embed/")[1].split("?")[0];
        fetchVideoInfo(videoId);
      }

      function onPlayerStateChange(event) {
        if (event.data === YT.PlayerState.PLAYING) {
          setInterval(updateTimeDisplay, 1000);
        } else if (
          event.data === YT.PlayerState.PAUSED ||
          event.data === YT.PlayerState.ENDED
        ) {
          lastPauseStopTime = player.getCurrentTime();
          updatePauseStopTimeDisplay();
        }
      }

      function loadVideo(urlParam = null) {
        let url = urlParam || document.getElementById("urlInput").value;
        videoId = extractVideoId(url) || url;
        if (videoId) {
          document.getElementById("player").src =
            "https://www.youtube-nocookie.com/embed/" +
            videoId +
            "?enablejsapi=1";
          setTimeout(() => {
            player = new YT.Player("player", {
              events: {
                onReady: onPlayerReady,
                onStateChange: onPlayerStateChange,
              },
            });
          }, 500);
          fetchVideoInfo(videoId);
        }
      }

      function extractVideoId(url) {
        var regExpWatch =
          /^.*(?:youtu\.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        var regExpShorts = /^.*youtube\.com\/shorts\/([^#\&\?]*).*/;
        var regExpLive = /^.*youtube\.com\/live\/([^#\&\?]*).*/;
        var match =
          url.match(regExpWatch) ||
          url.match(regExpShorts) ||
          url.match(regExpLive);
        return match && match[1].length == 11 ? match[1] : null;
      }

      function pauseVideo() {
        player.pauseVideo();
      }

      function stopVideo() {
        player.stopVideo();
      }

      function seekForward() {
        player.seekTo(player.getCurrentTime() + 30);
      }

      function seekBackward() {
        player.seekTo(player.getCurrentTime() - 30);
      }

      async function pasteUrl() {
        try {
          const text = await navigator.clipboard.readText();
          document.getElementById("urlInput").value = text;
        } catch (err) {
          console.error("Failed to paste: ", err);
        }
      }

      function shareVideo() {
        var currentSrc = document.getElementById("player").src;
        var videoId = currentSrc.split("/embed/")[1].split("?")[0];
        var shareUrl = "https://www.youtube.com/watch?v=" + videoId;
        navigator.clipboard
          .writeText(shareUrl)
          .then(() => {
            alert("Video URL copied to clipboard!");
          })
          .catch((err) => {
            console.error("Failed to copy: ", err);
          });
      }

      function promptSeekTo() {
        document.getElementById("seekModal").style.display = "block";
        document.getElementById("seekInput").value = "";
      }

      function closeSeekModal() {
        document.getElementById("seekModal").style.display = "none";
      }

      function confirmSeek() {
        const input = document.getElementById("seekInput").value.trim();
        const seconds = parseTimeToSeconds(input);
        if (!isNaN(seconds)) {
          player.seekTo(seconds);
          closeSeekModal();
        } else {
          alert("Formato inválido. Use hh:mm:ss ou mm:ss.");
        }
      }

      function parseTimeToSeconds(timeStr) {
        const parts = timeStr.split(":").map(Number);
        if (parts.length === 3) {
          return parts[0] * 3600 + parts[1] * 60 + parts[2];
        } else if (parts.length === 2) {
          return parts[0] * 60 + parts[1];
        } else if (parts.length === 1) {
          return parts[0];
        } else {
          return NaN;
        }
      }

      async function saveVideoData() {
        console.log('saveVideoData chamado às', new Date().toLocaleString());
        console.log('Dados a salvar:', {
          videoId: videoId,
          videoTitle: videoTitle,
          channelName: channelName,
          lastPauseStopTime: lastPauseStopTime,
          types: {
            videoId: typeof videoId,
            videoTitle: typeof videoTitle,
            channelName: typeof channelName,
            lastPauseStopTime: typeof lastPauseStopTime
          }
        });
        if (!videoId || !videoTitle || !channelName || lastPauseStopTime === 0) {
          alert("Carregue um vídeo e pause/stop para salvar.");
          console.log('Validação falhou: dados incompletos');
          return;
        }
        const thumbnail = `https://img.youtube.com/vi/${videoId}/0.jpg`;
        const dataToInsert = {
          video_id: String(videoId),
          title: String(videoTitle),
          channel_name: String(channelName),
          pause_time: Number(lastPauseStopTime),
          thumbnail: String(thumbnail)
        };
        console.log('Dados formatados para Supabase:', dataToInsert);
        console.log('Cabeçalhos enviados:', {
          Authorization: `Bearer ${supabaseKey.substring(0, 20)}...`,
          apikey: supabaseKey.substring(0, 20) + '...'
        });
        try {
          const { data, error } = await supabase
            .from('video_data')
            .insert([dataToInsert]);
          if (error) {
            console.error('Erro ao salvar no Supabase:', error);
            alert(`Erro ao salvar no Supabase: ${error.message} (Código: ${error.code || 'N/A'})`);
            return;
          }
          console.log('Dados salvos com sucesso:', data);
          try {
            document.getElementById("saveSuccessModal").style.display = "block";
          } catch (modalError) {
            console.error('Erro ao exibir modal:', modalError);
            alert("Vídeo salvo com sucesso! (Modal falhou)");
          }
        } catch (err) {
          console.error('Erro inesperado ao salvar:', err);
          console.log('Detalhes do erro:', {
            name: err.name,
            message: err.message || 'Mensagem vazia',
            stack: err.stack || 'Stack vazio'
          });
          alert(`Erro inesperado ao salvar no Supabase: ${err.message || 'Erro sem mensagem (ver console para detalhes)'}`);
        }
      }

      function closeSaveSuccessModal() {
        document.getElementById("saveSuccessModal").style.display = "none";
      }

      window.onload = function() {
        const params = new URLSearchParams(window.location.search);
        const paramVideoId = params.get('videoId');
        const paramPauseTime = parseFloat(params.get('pauseTime'));
        if (paramVideoId) {
          loadVideo(paramVideoId);
          setTimeout(() => {
            if (!isNaN(paramPauseTime)) {
              player.seekTo(paramPauseTime);
            }
          }, 1000);
        }
      };
    </script>
  </body>
</html>